stage('Terraform Init') {
    when {
        allOf {
            expression { params.RUN_TERRAFORM }
            expression { params.ACTION in ['deploy', 'destroy'] }
        }
    }
    steps {
        dir(env.TF_DIR) {
            terraform(
                name: 'terraform',
                init: true
            )
        }
    }
}

stage('Terraform Plan') {
    when {
        allOf {
            expression { params.ACTION == 'deploy' }
            expression { params.RUN_TERRAFORM }
        }
    }
    steps {
        dir(env.TF_DIR) {
            terraform(
                name: 'terraform',
                plan: [out: 'tfplan']
            )
        }
    }
}

stage('Terraform Apply') {
    when {
        allOf {
            expression { params.ACTION == 'deploy' }
            expression { params.RUN_TERRAFORM }
        }
    }
    steps {
        dir(env.TF_DIR) {
            terraform(
                name: 'terraform',
                apply: [plan: 'tfplan', autoApprove: true]
            )
        }
    }
}

stage('Terraform Destroy') {
    when {
        allOf {
            expression { params.ACTION == 'destroy' }
            expression { params.RUN_TERRAFORM }
        }
    }
    steps {
        dir(env.TF_DIR) {
            terraform(
                name: 'terraform',
                destroy: [autoApprove: true]
            )
        }
    }
}
